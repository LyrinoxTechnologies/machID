name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install dmidecode
        run: sudo apt-get update && sudo apt-get install -y dmidecode

      - name: Download dependencies
        run: go mod download

      - name: Run tests (non-root)
        run: go test -v -short ./...

      - name: Run tests (with sudo for hardware access)
        run: sudo go test -v ./...

  lint:
    name: Lint
    runs-on: ubuntu-latest
    # golangci-lint doesn't support Go 1.25 yet, skip for now
    if: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    # CodeQL requires enabling Code Scanning in repo settings first
    if: false
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: go

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:go"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          # G104: Unhandled Close() errors in deferred cleanup - errors are non-actionable
          # G301/G306: Directory permissions (0750/0600) for cache - intentionally restrictive
          # G304: File read path from internal cache location - not user-controlled
          args: -exclude=G104,G301,G304,G306 ./...

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
